## LVS

linux vartual server的缩写linux虚拟服务，由内核（ipvsadm）实现的负载均衡，性能高。

**作用**：提供负载均衡技术和linux操作系统实现一个高性能、高可用的服务器集群，具有良好的可靠性、可扩展性和可操作性，低廉的成本。

### 一、优缺点

#### 优势：

**高并发连接**：由超强的承载能力和并发处理能力，单台lvs负载均衡器可支持上万并发。

**稳定性强**：工作在网络4层之上仅作分发之用，在负载均衡软件里性能最强，稳定性最好，资源消耗低

**成本低廉**：一台服务器对标几十万台硬件负载均衡器

**配置简单**：几行命令即可完成配置

**支持多种算法**：支持多种论调算法，可以根据业务场景灵活调配

*静态算法*只考虑算法进行调度，不考虑后端服务器的实际连接情况和负载情况

RR轮叫调度 WRR加权轮叫

*动态算法*前段的调度器会根据后端真实服务器的实际连接情况来分配请求（不会只显示前端不显示后端）

LC最少连接 WLC加权最少连接 NQ永不排队/最少队列调度

**多种工作模式**：四种，LVS/NAT，LVS/DR，LVS/TUN，LVS/full-nat

**应用范围广**：几乎对所有应用做负载均衡，包括http、数据库、dns、ftp服务等

#### 不足：

不支持7层，机制庞大不适合小规模应用

### 二、核心组件和专业术语

#### 核心组件

lvs的管理工具和内核模块（类似mysql的客户端和service端）

ipvsadm：用户空间的命令行工具，用于管理集群及集群服务上的rs等

ipvs：工作于内核上的程序，根据用户定义集群实现请求转发；

#### 专业术语

| 专业术语 | 原型                | 含义                 |
| -------- | ------------------- | -------------------- |
| VS       | Virtual Server      | 虚拟服务             |
| DR       | Director,Balancer   | 负载均衡器、分发器   |
| RS       | Real Server         | 后端请求处理服务器   |
| CIP      | Client IP           | 用户端IP             |
| VIP      | Director Virtual IP | 负载均衡器虚拟IP     |
| DIP      | Director IP         | 负载均衡IP           |
| RIP      | Real Server IP      | 后端请求处理服务器IP |

### 三、工作模式

#### 四种工作模式：

\***LVS/NAT**：网络**地址转换**模式，进站/出站的数据流量经过分发器（IP负载均衡，**他修改的是IP地址**）--利用三层功能

- [ ] ​		开始时，目标地址变成C，处理完后源变成B，目标地址变成A

\***LVS/DR**：直接路由模式，只有进站的数据流量经过分发器（数据链路层负载均衡，因为他修改的是目的mac地址）--利用二层功能mac地址

- [ ] ​		RS和DR的ip相同，RS对ARP请求静默，目的mac变成C，因为源，ip没变，所以C直接还给A

**LVS/TUN**：隧道模式，只有进站的数据流量经过分发器

- [ ] ​		RS必须支持IPTUNNEL协议，需要公网ip，**类似DR但是三层**

**LVS/full-nat**：双向转换：通过请求报文的源地址为DIP，目标为RIP来实现转发：对于相应保温而已，修改源地址为VIP，目标地址为CIP来实现转发

- [ ] ​		开始时，源变成B，目标地址变成C，处理完后源变成B，目标地，址变成A，请求使用DNAT（目标地址转换），SNAT（源地址转，换），DIP可不同于RIP，**类似NAT但是第一轮源要变成DIP**

### 四、简单实验

##### 前置工作：

| 主机ip        | 主机名 | 说明                    |
| ------------- | ------ | ----------------------- |
| 10.0.0.160/24 | DR     | 安装ipvsadm的负载均衡器 |
| 10.0.0.161/24 | SR-1   | 后端                    |
| 10.0.0.162/24 | SR-2   | 后端                    |

1.网络使用nat模式

2.dip和vip在同一个网段

3.真实网关

```shell
systemctl disable --now firewalld #关闭防火墙

setenforce 0 #关闭selinux
```

##### DR篇

```shell
yum -y install ipvsadm #安装ipvsadm内核工具，主程序：/usr/sbin/ipvsadm

ip addr add dev ens33 192.168.182.10/32 #设置vip简写ip a a dev ens33 192.168.182.10/32 临时，重启失效

ipvsadm --save >/etc/sysconfig/ipvsadm #保存规则

systemctl start ipvsadm #启动内核

ipvsadm -A -t 192.168.182.10:80 -s rr #按顺序先添加这一条虚拟服务器再添加真实服务器记录

ipvsadm -a -t 192.168.182.10:80 -r 192.168.182.110 -g #添加后端真实服务器

ipvsadm -a -t 192.168.182.10:80 -r 192.168.182.120 -g #添加后端真实服务器

ipvsadm -S >/etc/sysconfig/ipvsadm #保存规则
```

2.命令选项

-A 添加一条虚拟服务器记录

-t tcp服务

-u udp服务

-s 使用调度算法 rr wrr lc wlc nq等

例：ipvsadm -A -t 192.168.1.2:80 -s wrr

-a 添加一条真实主机记录

-t 虚拟服务器提供tcp

-u 虚拟服务器提供udp

-r 真实服务器地址

-m 指定lvs工作模式为nat模式

-g 指定lvs工作模式为直接路由器模式#默认

-i 指定lvs的工作模式为隧道模式

-w 指定权重值

-p 会话保存时间

例：ipvsadm -a -t 192.168.1.2:80 -r 192.168.2.10:80 -m -w 1

-E 编辑内核模拟器表中的一条虚拟服务器记录

-D 删除..

-C 清除所有

-R 恢复虚拟服务器规则

-S 保存虚拟服务器规则到标准输出，输出为-R选项可读的格式

-d 删除一条虚拟服务器记录中的某条真实服务器记录 对标-a

-L 显示内核虚拟服务器表

-n 以数字的形式输出ip和端口

--stats 统计信息

--rate 输出速率信息

-Z 虚拟服务器计数器清零



![微信图片_20241214142728](C:\Users\Administrator\Desktop\学习笔记\images\微信图片_20241214142728.png)



##### RS篇

```shell
yum -y install nginx #安装nginx

echo "rs-*" >>/usr/share/nginx/html/index.html #修改页面内容

echo 1>/proc/sys/net/ipv4/conf/all/apr_ignore #arp静默 临时

echo 1>/proc/sys/net/ipv4/ip_forward #开启路由转发

echo 2>/proc/sysy/net/ipv4/conf/all/apr_announce #匹配精确地址回包，要保证rs能够直接将数据返还给客户端
```

要永久修改这些配置，可以通过编辑 `/etc/sysctl.conf` 文件来实现。

```plaintext
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.ip_forward = 1
net.ipv4.conf.all.arp_announce = 2
```

添加完成后，保存文件，并执行 `sysctl -p` 命令使配置生效

### 五、相关面试题

#### ***\*6.nginx lvs haproxy 三个有什么区别\****

lvs优势：抗负载能力很强、工作稳定、不占什么流量、pv超过1000万可用lvs

nginx：nginx工作第7层，支持http应用本身分流，lvs没有这个功能

nginx 对网络依赖很小，nginx安装简单也稳定,流量日pv <=1000万nginx足以能撑住，一般不是特别大的公司都达不到lvs使用级别。官方说并发50000都没什么问题，测试过并发1-2万根本没什么问题

haproxy:

1).haproxy是支持虚拟主机的，可以工作在4、7层(支持多网段)

2).haproxy的优点能够补充nginx的一些缺点，比如支持session的保持，Cookie的引导；同时支持通过获取指定的url来检测后端服务器的状态。

3).haproxy跟lvs类似，本身就只是一款负载均衡软件；单纯从效率上来讲haproxy会比nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。

4).haroxy支持TCP协议的负载均衡转发，可以对MySQL读进行负载均衡，对后端的MySQL节点进行检测和负载均衡。

#### ***\*7.lvs主要3种工作模式原理\****

1).NAT模式（NAT）

原理：就是把客户端发来的数据包的IP头的目的地址，在负载均衡器上换成其中一台RS的IP地址，并发至此RS来处理,RS处理完成后把数据交给负载均衡器,负载均衡器再把数据包的原IP地址改为自己的IP，将目的地址改为客户端IP地址即可，负载均衡器再返回给客户端｡期间,无论是进来的流量,还是出去的流量,都必须经过负载均衡器｡

优点：集群中的物理服务器可以使用任何支持TCP/IP操作系统，只有负载均衡器需要一个合法的IP地址。

缺点：扩展性有限。当服务器节点（普通PC服务器）增长过多时,负载均衡器将成为整个系统的瓶颈，因为所有的请求包和应答包的流向都经过负载均衡器。当服务器节点过多时，大量的数据包都交汇在负载均衡器那，速度就会变慢！

2).IP隧道模式（TUN）

原理：首先要知道，互联网上的大多Internet服务的请求包很短小，而应答包通常很大。那么隧道模式就是，把客户端发来的数据包，封装一个新的IP头标记(仅目的IP)发给RS,RS收到后,先把数据包的头解开,还原数据包,处理后,直接返回给客户端,不需要再经过负载均衡器｡注意,由于RS需要对负载均衡器发过来的数据包进行还原,所以说必须支持IPTUNNEL协议｡所以,在RS的内核中,必须编译支持IPTUNNEL这个选项

优点：负载均衡器只负责将请求包分发给后端节点服务器，而RS将应答包直接发给用户。所以，减少了负载均衡器的大量数据流动，负载均衡器不再是系统的瓶颈，就能处理很巨大的请求量，这种方式，一台负载均衡器能够为很多RS进行分发。而且跑在公网上就能进行不同地域的分发。

缺点：隧道模式的RS节点需要合法IP，这种方式需要所有的服务器支持”IP Tunneling”(IP Encapsulation)协议，服务器可能只局限在部分Linux系统上。

3).直接路由模式（DR）

原理：负载均衡器和RS都使用同一个IP对外服务｡但只有DR对ARP请求进行响应,所有RS对本身这个IP的ARP请求保持静默｡也就是说,网关会把对这个服务IP的请求全部定向给DR，也就是客户端发送请求给lvs的DR模式,而DR收到数据包后根据调度算法,找出对应的RS,把目的MAC地址改为RS的MAC（因为IP一致）并将请求分发给这台RS｡这时RS收到这个数据包,处理完成之后，由于IP一致，可以直接将数据返给客户，则等于直接从客户端收到这个数据包无异,处理后直接返回给客户端｡由于负载均衡器要对二层包头进行改换,所以负载均衡器和RS之间必须在一个广播域,也可以简单的理解为在同一台交换机上｡

优点：和TUN（隧道模式）一样，负载均衡器也只是分发请求，应答包通过单独的路由方法返回给客户端。与VS-TUN相比，VS-DR这种实现方式不需要隧道结构，因此可以使用大多数操作系统做为物理服务器。

缺点：（不能说缺点，只能说是不足）要求负载均衡器的网卡必须与物理网卡在一个物理段上。

#### ***\*8.lvs工作原理，算法，工作模式？\****

lvs：实现负载均衡集群部署的软件，有一台或多台调度器组成，通过加载lvs内核模块并且生成虚拟ip,通过虚拟ip接收客户端的请求，再根据自身配置的调度算法，实现对请求的转发

***\*算法：\****大概有10种，主要的有下面几种：

静态算法： 只是根据算法进行调度并不考虑后端REALSERVER的实际连接情况

rr：轮询算法：  按照节点顺序一个一个来，均等地对待每一台服务器，不管服务器上的实际连接数和系统负载。

wrr：加权轮询算法：根据节点权重以及节点顺序分发请求,调度器可以自动问询真实服务器的负载情况,并动态调整权值。

sh:源地址散列调度算法：匹配客户端最近一次访问的服务节点，并将请求交给这个服务节点，根据源地址散列算法进行静态分配固定的服务器资源。或者说： 负载均衡器选择响应时间最短的后端服务器来处理请求。这可以确保请求被发送到响应速度最快的服务器上。

dh:目标地址散列算法：根据目标ip地址进行哈希计算，得到散列值，匹配客户端最近一次访问的服务节点，并将请求交给这个服务节点，根据目标ip地址通过散列函数将目标ip与服务器建立影射关系，出现服务器不可用或负载过高的情况下，发往该目标ip的请求会固定发给该服务器。

动态算法：

lc:最少连接数算法：动态地将网络请求调度到已建立的连接数最少的服务器上。

wlc:加权最少连接数算法：调度器可以自动问询真实服务器的负载情况，并动态调整权值。

lblc：基于局部的最少连接数调度算法: 先根据请求的目标ip地址寻找最近的该目标ip地址所有使用的服务器，如果这台服务器依然可用，并有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其他可行的服务器，即：

如果服务节点因为自身故障暂时无法接收请求，则调度器在服务器集群中找出一台连接量最少的节点来处理请求。

lblcr:带复制的基于局部的最少连接算法：记录的不是要给目标ip与一台服务器之间的连接记录，它会维护一个目标ip到一组服务器之间的影射关系，防止单点服务器负载过高。

***\*工作模式：\****主要模式有3种

1).DR模式：（也是默认模式，直接路由模式）

客户端访问负载均衡器的vip，此时在集群中负载均衡器和后端的realserver都具有vip，所以负载局衡器通过vip进行转发是不实际的。那么只能通过二层协议，修改数据包二层的目标mac地址来进行转发，后端服务器处理后，通过本机的lo网卡上的vip直接返回数据包。

a).环境，为了模拟生产环境，我们将dip rip 设置为同一个网段，dr和rs上面的虚拟ip均为vip(生产环境中的公网ip)。
b).注意，arp静默需要开启，后端服务器不接受请求，只处理

2).NAT模式：

客户端访问负载均衡器的vip，负载均衡器通过转换目标ip地址的方式，实现负载均衡，将本该发送给负载均衡器的数据包的目标地址，修改成后端real server的ip地址，然后又rs进行处理并返回，返回过程中，经过负载均衡器，负载均衡器将源地址转换为vip，完成本次请求。

a).环境，为了模拟生产环境，我们使用 一台centos7服务器作为负载均衡器，配置两块网卡，一块设置vip(桥接，生产中是公网ip)，一块设置dip(nat或仅主机模式，生产中是内网ip)，后端设置rip(nat或仅主机模式，于dip同一网段)

b).注意，负载均衡器需要开启路由转发，所有服务器均关闭防火墙，selinux。如果测试环境中，使用的是于后端服务器同一网段的客户端访问，则会丢弃数据包，超时连接，这种情况需要在后端real-server添加路由规则，route add -host cip gw dip 则可以访问

3).TUN模式（隧道模式）:

客户端访问负载均衡器的vip，这种模式，可以跨区域进行负载均衡，vip和rip均为公网ip，dip将请求发送给rip的过程中是加密的，后端rs上的vip直接将请求进行回复，不经过dr负载均衡器。
a).环境，需要两个公网ip
b).添加vip在隧道网卡。
