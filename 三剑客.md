## 三剑客

三剑客的功能非常强大，但我们只需要掌握他们分别擅长的领域即可：**grep**擅长查找功能，sed擅长取行和替换。**awk**擅长取列。

grep,sed和awk都是读一行处理一行，直到处理完成。


接收一行作为输入


把刚刚读入进来得到文本进行分解


使用处理规则处理文本


输入一行，赋值给$0，直至处理完成

把处理完成之后的所有数据交给END{}来再次处理

### 前置：正则表达式

| 元字符      | 功能                                | 说明                       |
| ----------- | ----------------------------------- | -------------------------- |
| ^           | 匹配首行                            | 表示以某个字符开头         |
| $           | 匹配空行                            | 表示以某个字符结尾         |
| ^$          | 空行的意思                          | 表示空行的意思             |
| .           | 匹配任意单个字符                    | 表示任意一个字符           |
| *           | 字符*匹配0或多个此字符              | 表示重复的任意多个字符     |
| \           | 屏蔽一个元字符的特殊含义            | 表示去掉有意义的元字符含义 |
| []          | 匹配中括号内的字符                  | 表示过滤括号内的字符       |
| .*          | 代表任意多个字符                    | 表示任意多个字符           |
| lele\{n\}   | 用来匹配前面lele出现的次数，n为次数 | 统计前面lele出现的次数     |
| lele\{n,\}  | 含义同上，但是最少为n               |                            |
| lele\{n,m\} | 次数在n和m之间                      |                            |
| \b          | 单词边界                            | 分割，一侧单词字符一侧空   |

### 一、grep

##### `grep [OPTIONS] PATTERN [FILE...]`

| 命令              | 作用                                                       |
| ----------------- | ---------------------------------------------------------- |
| grep -i           | 忽略大小写                                                 |
| grep -v           | 输出的内容反转                                             |
| grep -n           | 带行号输出                                                 |
| grep -r           | 文件递归搜索                                               |
| grep -c           | 输出内容的行数（在第几行）                                 |
| grep -E           | 正则表达式                                                 |
| grep -A           | 检索到的内容以及之后（after）                              |
| grep -B           | 检索到的内容以及之前（before）                             |
| grep -C           | 检索到的内容的前后（三个皆可带-数字）                      |
| grep -q           | 布尔值，搜到了就是true                                     |
| grep -o           | 仅显示匹配到的字符串                                       |
| grep -e           | 实现多个选项间的or关系，例如：grep –e ‘cat ’ -e ‘dog’ file |
| grep --color=auto | 对匹配到的文本着色显示                                     |

| 进阶命令                        | 作用         | 示例                                           |
| ------------------------------- | ------------ | ---------------------------------------------- |
| grep \[^\]                      | 单字符取反   | grep \[^abc\] a.txt #只有abc的行就不输出       |
| grep \[a-z\]                    | 匹配单字符   | grep  \[a-z\] a.txt #输出含有a-z任一字母的行   |
| grep [[:alnum:]]或者[0-9a-zA-Z] | 匹配字母数字 | grep [[:alnum:]] a.txt或grep [0-9A-Za-z] a.txt |
| [[:alpha:]] 或 [a-zA-Z]         | 字母         |                                                |
| [[:upper:]] 或 [A-Z]            | 大写         |                                                |
| [[:lower:]] 或 [a-z]            | 小写         |                                                |
| [[:space:]]                     | 空格         |                                                |
|                                 |              |                                                |
|                                 |              |                                                |

#### 案例：

```shell
#输出含::但是不含sh的行
cat shadow.txt|grep -n ::|grep -v sh 

#输出含Dec-15-03:06:49的行
grep -E '([a-z]|[A-Z]){3}-[0-9]{2}-[0-9]{2}:[0-9]{2}:[0-9]{2}' a.log
grep -E '[a-zA-Z]{3}-[0-9]{2}-[0-9]{2}:[0-9]{2}:[0-9]{2}' a.log

#输出ip格式的行
grep -E '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' access.log

#输出更严谨的ip格式
grep -E '((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)' access.log
```

### 二、sed

##### `sed [option]... 'script' inputfile`

sed是一种流编辑器，它一次处理一行内容。处理时，把当前处理的行存储在临时缓冲区中，称为“模式空间”（pattern space），接着用sed命令处理缓冲区中的内容，处理完成后，把缓冲区的内容送往屏幕。然后读入下行，执行下一个循环。如果没有使诸如‘D’ 的特殊命令，那会在两个循环之间清空模式空间，但不会清空保留空间。这样不断重复，直到文件末尾。文件内容并没有改变，除非你使用重定向存储输出。

| 参数   | 作用                     | 示例                                         |
| ------ | ------------------------ | -------------------------------------------- |
| -n     | 不打印没被处理的行       | sed -n a.log                                 |
| -e     | 指定多个编辑命令         | sed -e 's/a/b/' -e 's/c/d/p' a.log           |
| -f     | 从指定文件中读取编辑脚本 | sc.sed里有sed脚本规则，则sed -f sc.sed a.log |
| -r     | 支持使用扩展正则         |                                              |
| -i     | 直接编辑文件             | sed '2,5d' -i a.log                          |
| -i.bak | 备份完再编辑             | sed '2,5d' -i.bak a.log                      |

| script地址定界 | 说明                         | 示例                                                         |
| -------------- | ---------------------------- | ------------------------------------------------------------ |
| 不给地址       | 全文进行处理                 | sed a.log打印所有                                            |
| 3p             | 指定的行                     | sed '3p' a.log打印第三行                                     |
| $p             | 最后一行                     | sed '$d' a.log删除最后一行                                   |
| /oct/          | 被此处模式所能够匹配的每一行 | sed -n '/oct/p' a.log显示含oct的行                           |
| 3,5p           | 3到5行                       | sed -n '3,5p' a.log打印三到五行                              |
| 3,+5#          | 3行到往后5行                 | sed -n '3,5p' a.log打印三和三后面的五行                      |
| /p1/,/p2/      | 从含p1的行到含p2的行         | sed -n '/start/,/end/p' a.log 打印含start行开始到含end行结束 |
| ^#,/p1/        | 从#行开始到含p1行结束        | sed -n '3,/root/p' a.log 打印三行开始到含end行结束           |
| 1~2            | 奇数行                       | sed -n '1~2p' a.log奇数行                                    |
| 2~2            | 偶数行                       | sed -n '2~2p' a.log偶数行                                    |

| 编辑命令 | 说明                 | 示例                                            |
| -------- | -------------------- | ----------------------------------------------- |
| //d      | 删除模式空间匹配的行 | sed '/a/d' a.log删除含a的行                     |
| //p      | 显示匹配的行         |                                                 |
| a ----   | 后面插入----         | sed '2a ---------' a.log第二行后面插入--------- |
| i        | 前面插入             | sed '2i ---------' a.log第二行前面插入--------- |
| s///     | 替换                 | sed -n 's/a/b/' a.log 替换含a的第一行的a为b     |
| ///g     | 全局                 | sed -n 's/a/b/g' a.log 替换含a的所有的a为b      |

#### 案例：

```
#将文件中的3行后全部删除
sed '3,$d' a.log

#删除含root和docker的行，把Dec改成Oct，在第二行后面添加NI行和HAO行，在每行下面加上---------
sed   -e '/root&docker/d' -e 's/Dec/Oct/g' -e '2a NI\nHAO' -e 'a ---------' a.log

#输出网卡的ip部分
[root@local117 ~]# ifconfig eth0|sed -n -e 's/.*inet //' -e 's/  net.*$//p'
10.0.0.117
```

### 三、awk

主要用来格式化的

##### `awk options 'pattern {action}' file`

##### 1.**选项参数说明：**

- `options`：是一些选项，用于控制 `awk` 的行为。
- `pattern`：是用于匹配输入数据的模式。如果省略，则 `awk` 将对所有行进行操作。
- `{action}`：是在匹配到模式的行上执行的动作。如果省略，则默认动作是打印整行

##### 2.**options 参数说明：**

- `-F <分隔符>` 或 `--field-separator=<分隔符>`： 指定输入字段的分隔符，默认是空格。使用这个选项可以指定不同于默认分隔符的字段分隔符。
- `-v <变量名>=<值>`： 设置 `awk` 内部的变量值。可以使用该选项将外部值传递给 `awk` 脚本中的变量。
- `-f <脚本文件>`： 指定一个包含 `awk` 脚本的文件。这样可以在文件中编写较大的 `awk` 脚本，然后通过 `-f` 选项将其加载。
- `-V` 或 `--version`： 显示 `awk` 的版本信息。
- `-h` 或 `--help`： 显示 `awk` 的帮助信息，包括选项和用法示例。

awk '{print}' file

awk '{print $1 $2}'

```
#打印整行
awk '{print}' file
#打印第一列第二列
awk '{print $1 $2}' a.log #无间隔，用逗号分割有间隔
```

参数：**-F**：定义分隔符

```
awk -F ',' '{print $1,$5}' a.log #根据,判断第几列，
```

| 预定义变量 | 含义                      | 示例                                   |
| ---------- | ------------------------- | -------------------------------------- |
| NF         | 一行有多少列，可配合$使用 | awk '{print $NF}' a.log #打印最后一列  |
| $num       | 第几列                    | 同上，最后一列                         |
| NR         | 行号                      | awk '{print NR}' a.log #打印每行的行号 |

##### 3.特殊变量

##### awk处理流程：

BEGIN{}：最开始执行

//：正则

{}：循环体

END{}：最后执行

| 函数   | 说明           |
| ------ | -------------- |
| print  | 打印           |
| printf | 格式化打印     |
| %s     | 字符串         |
| %d     | 数字           |
| -      | 左对齐         |
| +      | 右对齐         |
| 15     | 至少占用15字符 |

OFS：自定义分隔符，配合BEGIN使用

```
awk 'BEGIN{OFS=" >>>"}{print $1,$3}' a.log
```

```
awk -F: 'BEGIN{OFS=" | "}{printf "|%+15s|%-15s|\n", $NF, $1}' /etc/passwd
#以|分隔，%+15s右对齐至少占用15字符，配合printf实现格式化输出

awk '{printf "|%+15s|%-15s|\n",$NF,$1}' a.log
#功能差不多，注意printf后每个参数都要有逗号
```

##### 4.定位功能

```
awk -F: '/root/{print $0}' /etc/passwd
#先执行正则再执行循环，匹配文件内含有root的每一行

awk -F: '/^root/{print $0}' /etc/passwd
#匹配root开头的行
```

##### 5.比较表达式

| 符号 | 含义     |
| ---- | -------- |
| >    | 大于     |
| <    | 小于     |
| >=   | 大于等于 |
| <=   | 小于等于 |
| ~    | 包含     |
| !~   | 不包含   |

```
#要求打印属组ID大于属主ID的行
awk -F: '$4 > $3{print $0}' /etc/passwd
```

```
#打印结尾包含root的行
awk '$NF ~/root/{print $0}' a.log
```

##### 6.逻辑表达式

| 算数表达式 | 含义 |
| ---------- | ---- |
| +          | 加   |
| -          | 减   |
| *          | 乘   |
| /          | 除   |
| %          | 求余 |

```

#要求匹配打印出属组 + 属主的ID 大于 2000 的
awk -F: '$3 + $4 > 2000{print $0}' /etc/passwd
```

```
#要求属组 * 属主的ID 大于 2000
awk -F: '$3 * $4 > 2000{print $0}' /etc/passwd
```

```
#要求打印偶数行
awk -F: 'NR % 2 == 0{print $0}' /etc/passwd
```

##### 7.流程控制

流程控制只存在循环之中

```
awk -F: '{if($3>$4){print "大于"}else{print "小于或等于"}}' /etc/passwd
```

if 使用格式:

| 格式                    | 说明   |
| ----------------------- | ------ |
| if(){}                  | 但分支 |
| if(){}else{}            | 双分支 |
| if(){}else if(){}else{} | 多分支 |

##### for循环

```
#每一行打印10次
awk -F: '{for(i=10;i>0;i--){print $0}}' /etc/passwd
```

##### while循环

while 使用格式

```
#每一行打印10次
awk -F: '{i=1; while(i<10){print $0, i++}}' /etc/passwd
```
